name: Coverage

on: pull_request

jobs:
  coverage:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout branch
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98
      - name: Setup pnpm
        uses: ./.github/actions/setup-pnpm

      - name: Install Playwright
        run: pnpm run install-playwright

      - name: Run test with coverage
        run: pnpm run -F main test -- --coverage

      - name: Upload coverage report
        id: upload-coverage
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f
        with:
          name: coverage-report
          path: apps/main/coverage/
          retention-days: 7

      - name: Comment PR with coverage URL
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BODY="## Coverage Report
          [カバレッジレポートをダウンロード](${{ steps.upload-coverage.outputs.artifact-url }})"

          COMMENT_ID=$(gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
            --jq '.[] | select(.body | startswith("## Coverage Report")) | .id')

          if [ -n "$COMMENT_ID" ]; then
            gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments/"$COMMENT_ID" \
              -X PATCH -f body="$BODY"
          else
            gh pr comment ${{ github.event.pull_request.number }} --body "$BODY"
          fi
